if (self.CavalryLogger) { CavalryLogger.start_js(["NzIqn"]); }

__d("MercurySearchContextResults",["KeyedCallbackManager","MercuryAPIArgsSource","MercuryIDs","MercuryPayloadSource","MercuryThreadlistConstants","MercuryThreadIDMap","RangedCallbackManager","MercuryServerDispatcher","MercuryServerPayloadPreprocessor","MessengerMessageTransformer.bs","WebMessengerConstants"],(function a(b,c,d,e,f,g){__p&&__p();var h=c("MercuryThreadIDMap").get(),i=c("MercuryServerPayloadPreprocessor").get(),j=new(c("KeyedCallbackManager"))(),k=c("MercuryThreadlistConstants").WEBMESSENGER_SEARCH_SNIPPET_COUNT,l=c("WebMessengerConstants").MORE_SEARCH_CONTEXT_COUNT,m={getSearchContext:function q(r,s,t){__p&&__p();if(r){var u=j.executeOrEnqueue(r,function(z){var A=o(z,r);t(A)}),v=j.getUnavailableResources(u);if(v.length){var w={message_id:r,limit:k+1},x=h.getServerIDFromClientIDNow(s),y=c("MercuryIDs").tokenize(s);if(y.type=="user")w.other_user_fbid=x;else w.thread_fbid=x;p(w)}return u}},getMoreSearchContext:function q(r,s,t,u){__p&&__p();if(r){var v=j.getResource(r);if(v){var w=t==c("WebMessengerConstants").MORE_SEARCH_CONTEXT_UP?v.up_message_ids:v.down_message_ids,x=w.getCurrentArraySize()+l,y=w.executeOrEnqueue(0,x,function(){var D=o(v,r);u(D)}),z=w.getUnavailableResources(y);if(z.length){var A={message_id:r,limit:x,direction:t},B=h.getServerIDFromClientIDNow(s),C=c("MercuryIDs").tokenize(s);if(C.type=="user")A.other_user_fbid=B;else A.thread_fbid=B;p(A)}return y}}},handleUpdate:function q(r){__p&&__p();if(r.graphql_payload){var s=r.graphql_payload.map(function(B){return c("MessengerMessageTransformer.bs").transformMessage(r.viewer,B,r.thread_data,r.for_page)});i.handleUpdate({actions:s,payload_source:c("MercuryPayloadSource").SERVER_SEARCH})}var t=r.search_context||{};for(var u in t){var v=t[u],w=v.other_user_fbid||v.thread_fbid,x=h.getClientIDFromServerIDNow(w),y=!j.getResource(u),z=y?{thread_id:x,up_message_ids:new(c("RangedCallbackManager"))(),down_message_ids:new(c("RangedCallbackManager"))()}:j.getResource(u),A=y?k+1:l;if(v.up_message_ids&&(z.up_message_ids.getCurrentArraySize()===0||v.up_message_ids.length>=z.up_message_ids.getCurrentArraySize()))n(z.up_message_ids,v.up_message_ids,A);if(v.down_message_ids&&(z.down_message_ids.getCurrentArraySize()===0||v.down_message_ids.length>=z.down_message_ids.getCurrentArraySize()))n(z.down_message_ids,v.down_message_ids,A);if(y)j.setResource(u,z)}},unsubscribe:function q(r,s,t){if(s){var u=j.getResource(s);if(u)if(t==c("WebMessengerConstants").MORE_SEARCH_CONTEXT_UP)u.up_message_ids.unsubscribe(r);else u.down_message_ids.unsubscribe(r);else j.unsubscribe(r)}}};function n(q,r,s){var t=q.getCurrentArraySize(),u=r.length<t+s;if(r.length){q.removeAllResources();q.addResourcesWithoutSorting(r,0)}if(u)q.setReachedEndOfArray()}function o(q,r){var s=q.up_message_ids.hasReachedEndOfArray(),t=q.up_message_ids.getAllResources();if(!s)t.shift();var u=q.down_message_ids.hasReachedEndOfArray(),v=q.down_message_ids.getAllResources();if(!u)v.pop();return{thread_id:q.thread_id,message_id:r,up_message_ids:t,up_exhausted:s,down_message_ids:v,down_exhausted:u}}function p(q){q.client=c("MercuryAPIArgsSource").WEBMESSENGER;c("MercuryServerDispatcher").trySend("/ajax/mercury/search_context.php",q)}c("MercuryServerDispatcher").registerEndpoints({"/ajax/mercury/search_context.php":{mode:c("MercuryServerDispatcher").IMMEDIATE,handler:m.handleUpdate}});f.exports=m}),null);