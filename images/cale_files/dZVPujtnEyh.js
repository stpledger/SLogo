if (self.CavalryLogger) { CavalryLogger.start_js(["TdgAD"]); }

__d("MessengerDetailView.react",["cx","fbt","invariant","Bootloader","BootloadOnRender.react","CustomColorHighlighting.react","DataTransfer","EventReminderActions","EventRemindersGating","EventReminderStateStore","immutable","JSResource","LazyComponent.react","MercuryIDs","MercuryConfig","MercuryCanonicalGroupThreadStore","MercuryParticipants","MercuryThreadActions","MercuryThreadInfo","MercuryThreads","MessengerActions","MessengerComposerStore","MessengerComposerContainer.react","MessengerConversation.react","MessengerConversationContainer.react","MessengerDetailViewHeaderContainer.react","MessengerDomIDs.bs","MessengerErrorBoundary.react","MessengerPresenceStatusUtils","MessengerSettingsActions","MessengerSettingsStore","MessengerStateStore","MessengerThreadSearchStore","MessengerThreadInfoPanelContainer.react","MessengerThreadSearchActions","MessengerView","MessengerWebDriverTestIDs","Parent","PresenceStatus","React","SubscriptionsHandler","WorkchatDoNotDisturbBanner","AvailableList","emptyFunction","gkx","ifRequired","shallowCompare"],(function a(b,c,d,e,f,g,h,i,j){"use strict";__p&&__p();var k=c("MessengerDomIDs.bs").ids,l=c("WorkchatDoNotDisturbBanner").module;c("AvailableList");var m=c("React").PropTypes;function n(event,p,q,r){if(!c("EventRemindersGating").shouldShowPlansOnMessengerCom)return null;if(!p)return null;if(!event)return null;return c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("MessengerEventPlanContainer.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",null),component:c("React").createElement(c("LazyComponent.react"),{threadID:p,participants:q,viewer:r})})}var o=c("React").createClass({displayName:"MessengerDetailView",_composer:undefined,_refsConversationContainer:null,_subscriptionsHandler:new(c("SubscriptionsHandler"))(),propTypes:{activeThreadID:m.string,deliveryReceipts:m.object,messengerState:m.any,view:m.string,viewer:m.string.isRequired,isWorkUser:m.bool.isRequired},calculateState:function p(q){__p&&__p();var r=q.activeThreadID,s=c("MercuryThreads").getForFBID(q.viewer),t=c("MessengerComposerStore").getState();if(q.view===c("MessengerView").DETAIL.COMPOSE){!!t.recipients||j(0);var u=t.recipients;if(u.size===1)r=c("MercuryIDs").getThreadIDFromUserID(u.first().getUniqueID().toString());else if(u.size>1)r=c("MercuryCanonicalGroupThreadStore").getOrFetch(Array.from(u).map(function(A){return A.getUniqueID().toString()}))}var v=r?s.getOrFetch(r):null,w=c("immutable").Map();if(v&&r){w=w.withMutations(function(A){v.participants&&v.participants.forEach(function(B){A.set(B,c("MercuryParticipants").getOrFetch(B))});v.is_subscribed&&A.set(c("MercuryIDs").getParticipantIDFromUserID(q.viewer),c("MercuryParticipants").getOrFetch(c("MercuryIDs").getParticipantIDFromUserID(q.viewer)))});if(c("EventRemindersGating").shouldShowPlansOnMessengerCom){var event=v?v.lightweight_event:null;if(event)c("EventReminderActions").updateEventReminder(r,event);else{var x=c("EventReminderStateStore").getEvent(r);if(x&&x.exists)c("EventReminderActions").deleteEventReminder(r)}}}var y=c("ifRequired")("MessengerUploadFilesStore",function(A){return A.getState()},function(){return c("immutable").Map({})}),z=c("ifRequired")("MessengerSharePreviewStore",function(A){return A.getState()},function(){return c("immutable").Map({})});return{infoPanelCollapsed:c("MessengerSettingsStore").getSettings().info_sidebar_collapsed,activeThreadID:r,composerState:t,messengerState:c("MessengerStateStore").getState(),contactData:c("MessengerPresenceStatusUtils").getStatusFromCanonicalThread(w,v),activeThread:v,participants:w,searchResults:c("MessengerThreadSearchStore").getState(),uploadFilesState:y,sharePreivewState:z}},getInitialState:function p(){return babelHelpers["extends"]({dropTargetOverlayVisible:false},this.calculateState(this.props))},componentDidMount:function p(){this._subscribeToSubscrptionHandler([c("MessengerComposerStore"),c("MessengerStateStore"),c("MessengerThreadSearchStore"),c("MercuryCanonicalGroupThreadStore"),c("MercuryThreads"),c("MercuryParticipants"),c("PresenceStatus")]);if(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw"))c("Bootloader").loadModules(["MessengerUploadFilesStore"],function(q){this._subscribeToSubscrptionHandler([q])}.bind(this),"MessengerDetailView.react");if(c("gkx")("AT5M-KOnq98igVULtzbIXLLujZOrcPEb_vzPxIrrMO4yDC59FjeQpdoZs2nMsaoB9WIY9SOWsfOkycr87iOYdoQQ"))c("Bootloader").loadModules(["MessengerSharePreviewStore"],function(q){this._subscribeToSubscrptionHandler([q])}.bind(this),"MessengerDetailView.react")},_subscribeToSubscrptionHandler:function p(q){__p&&__p();var r=function(){this.setState(this.calculateState(this.props))}.bind(this),s=[];q.forEach(function(u){if(u.hasChanged&&u.getDispatchToken&&u.addListener)s.push(u.addListener(r));else if(u.subscribe)s.push(u.subscribe("change",r));else if(u.addListener)s.push(u.addListener("change",r));else j(0)});if(s.length>0){var t;this._subscriptionsHandler&&(t=this._subscriptionsHandler).addSubscriptions.apply(t,s)}},shouldComponentUpdate:function p(q,r){return c("shallowCompare")(this,q,r)},componentDidUpdate:function p(){this._handleResize()},componentWillUnmount:function p(){this._subscriptionsHandler&&this._subscriptionsHandler.release();this._subscriptionsHandler=null},componentWillReceiveProps:function p(q){this.setState(this.calculateState(q))},render:function p(){var q=this.state.activeThreadID,r=this._getMainLabelDetails(),s=void 0;if(this.state.activeThread)s=this.props.query==null?n(this.state.activeThread.lightweight_event,q,this.state.participants,this.props.viewer):null;return c("React").createElement("div",{"aria-labelledby":r.labelIDs,className:"_1q5-",role:"main"},c("React").createElement("div",{className:"hidden_elem",id:k.MAIN_LABEL},r.labelText),c("React").createElement(c("CustomColorHighlighting.react"),{className:"_wsc",customColor:this.state.activeThread&&this.state.activeThread.custom_color},c("React").createElement(c("MessengerDetailViewHeaderContainer.react"),{contactData:this.state.contactData,recipients:this.state.composerState.recipients,participants:this.state.participants,thread:this.state.activeThread,view:this.props.view,viewer:this.props.viewer,onResize:this._handleResize,onInfoPanelToggle:this._handleInfoPanelToggle,infoPanelCollapsed:this.state.infoPanelCollapsed,isWorkUser:this.props.isWorkUser}),l?c("React").createElement(l,{isCanonical:c("MercuryIDs").isCanonical(q),thread:this.state.activeThread,viewer:this.props.viewer}):null,c("React").createElement("div",{className:"_20bp"},this._renderInfoPanel(),c("React").createElement("div",{className:"_4_j4",onClick:this._handleConversationClick,onDragEnter:this._showDropTargetOverlay,onDragLeave:this._hideDropTargetOverlay,onDragOver:this._showDropTargetOverlay,onDrop:this._handleDrop,role:"presentation"},this._renderMainView(q),s,this._renderSearchView(q),this._renderFooterView(q),c("React").createElement("div",{className:(!this.state.dropTargetOverlayVisible?"hidden_elem":"")+" _2fg6"}),(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw")||c("gkx")("AT5M-KOnq98igVULtzbIXLLujZOrcPEb_vzPxIrrMO4yDC59FjeQpdoZs2nMsaoB9WIY9SOWsfOkycr87iOYdoQQ"))&&this._renderUploadFiles(q)))))},_renderUploadFiles:function p(q){if(!q)return null;var r=this.state.uploadFilesState.get(q)||{},s=this.state.sharePreivewState.get(q);return c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("MessengerDragAndDrop.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",null),component:c("React").createElement(c("LazyComponent.react"),{threadID:q,uploadedFiles:r.uploadedFiles,uploadingFiles:r.uploadingFiles,sharePreview:s})})},_renderSearchView:function p(q){return q&&!this.props.mid&&this.props.query!=null?c("React").createElement(c("BootloadOnRender.react"),{loader:c("JSResource")("MessengerThreadSearchContainer.react").__setRef("MessengerDetailView.react"),placeholder:c("React").createElement("div",{className:"_33p7 _5iwm"}),component:c("React").createElement(c("LazyComponent.react"),{loading:this.state.searchResults.loading,query:this.state.searchResults.query,selectedIndex:this.state.searchResults.selectedIndex,totalCount:this.state.searchResults.totalCount})}):null},_assignConversationContainerRef:function p(q){this._refsConversationContainer=q},_renderMainView:function p(q){if(!q)return c("React").createElement("div",{className:"_1ut7"});var r=this.state.contactData?this.state.contactData.contact:null;if(this.state.searchResults.messages)return c("React").createElement(c("MessengerErrorBoundary.react"),{component:"conversation"},c("React").createElement(c("MessengerConversation.react"),{className:"_1wfr",contact:r,deliveryReceipts:this.props.deliveryReceipts,downExhausted:this.state.searchResults.downExhausted,fetchMessages:c("MessengerThreadSearchActions").getMoreSearchContext,onVoiceClipCreate:this.handleAudioUpload,innerClassName:"_1r_-",isCanonical:c("MercuryIDs").isCanonical(q),isLoaded:true,isLoading:false,messages:this.state.searchResults.messages,onRead:c("emptyFunction"),participants:this.state.participants,thread:this.state.activeThread,threadID:q,upExhausted:this.state.searchResults.upExhausted,useManualFetch:true,viewer:this.props.viewer}));return c("React").createElement(c("MessengerErrorBoundary.react"),{component:"conversation"},c("React").createElement(c("MessengerConversationContainer.react"),{className:"_1wfr",contact:r,deliveryReceipts:this.props.deliveryReceipts,messengerState:this.props.messengerState,onVoiceClipCreate:this.handleAudioUpload,onMarkRead:this._handleMarkRead,participants:this.state.participants,ref:this._assignConversationContainerRef,thread:this.state.activeThread,threadID:q,viewer:this.props.viewer}))},_renderFooterView:function p(q){var r=c("MercuryConfig").ColdOpenBlock&&this.state.activeThread&&c("MercuryThreadInfo").isColdOpen(this.state.activeThread);return c("React").createElement(c("MessengerErrorBoundary.react"),{className:"_4rv3 _2pen",component:"composer"},c("React").createElement(c("MessengerComposerContainer.react"),{canReply:!!(!r&&(this.props.view===c("MessengerView").DETAIL.COMPOSE||this.state.activeThread&&c("MercuryThreadInfo").canReply(this.state.activeThread)&&!c("MercuryConfig").ViewerIsReadOnly)),fileUploader:this.state.uploadFilesState.get(q),onMount:function(s){return this._composer=s}.bind(this),onResize:this._handleResize,participants:this.state.participants,recipients:this.state.composerState.recipients,sharePreview:this.state.sharePreivewState.get(q),threadID:q,threadFBID:this.state.activeThread?this.state.activeThread.thread_fbid:null,thread:this.state.activeThread,view:this.props.view,viewer:this.props.viewer}))},_renderInfoPanel:function p(){var q=this.state,r=q.activeThread,s=q.contactData,t=q.infoPanelCollapsed,u=q.participants,v=this.props.view;if(!r||!u||v===c("MessengerView").DETAIL.COMPOSE)return null;return c("React").createElement("div",{className:(t?"hidden_elem":"")+" _4_j5","data-testid":c("MessengerWebDriverTestIDs").INFO_PANEL},c("React").createElement(c("MessengerErrorBoundary.react"),{className:"_4rv3",component:"conversation information"},c("React").createElement(c("MessengerThreadInfoPanelContainer.react"),{className:"_4_j9",contactData:s,participants:u,thread:r,viewer:this.props.viewer})))},_getMainLabelDetails:function p(){if(this.props.view===c("MessengerView").DETAIL.COMPOSE)return{labelText:i._("New Message"),labelIDs:k.MAIN_LABEL};return{labelText:i._("Conversation with"),labelIDs:k.MAIN_LABEL+" "+k.THREAD_TITLE}},_handleConversationClick:function p(q){__p&&__p();var r=this.props.activeThreadID;if(r&&this._refsConversationContainer&&this._refsConversationContainer.isScrolledToBottom())this._handleMarkRead(r);if(window.getSelection().toString()!=="")return;var s=q.target;if(s instanceof Node&&c("Parent").byTag(s,"a")!=null)return;var t=this._getComposer();t&&t.focusInput()},handleAudioUpload:function p(q){var r=this._getComposer();if(r!=null&&q!=null){r.handleAudioUpload(q);r.focusInput()}},_showDropTargetOverlay:function p(q){q&&q.preventDefault();this.setState({dropTargetOverlayVisible:true})},_hideDropTargetOverlay:function p(q){q&&q.preventDefault();this.setState({dropTargetOverlayVisible:false});var r=this._getComposer();r&&r.resetDrag()},_handleDrop:function p(q){__p&&__p();this._hideDropTargetOverlay(q);var r=this._getComposer();if(!r)return;q.nativeEvent.dataTransfer instanceof Object||j(0);var s=new(c("DataTransfer"))(q.nativeEvent.dataTransfer),t=s.getFiles();if(c("gkx")("AT5V6GuV7OE1f4CNmq1NUhZOeDrgnZF-AQ7WoOvZA8jFMJsYzyghwU79Bm31vgH-mi9DAlUGSFnfYvhwjhMfTolYEEzHhgUrhLD2UxTqbooHHw")&&t.length){c("MessengerActions").prepareFilesForSend(this.state.activeThreadID,q.nativeEvent.dataTransfer.files);return}if(t.length)r.handleFileUpload(t);else{var u=s.getText();if(u)r.handleTextDropped(u)}},_handleResize:function p(){var q=this._refsConversationContainer;if(q)q.handleResize()},_handleInfoPanelToggle:function p(){var q=!this.state.infoPanelCollapsed;this.setState({infoPanelCollapsed:q},function(){c("MessengerSettingsActions").changeSettings({info_sidebar_collapsed:q})})},_handleMarkRead:function p(q){c("MercuryThreadActions").getForFBID(this.props.viewer).markRead(q)},_getComposer:function p(){return this._composer}});f.exports=o}),null);